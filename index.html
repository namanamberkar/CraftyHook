<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="CraftyHook">
    <title>CraftyHook Studio</title>

    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json">

    <link rel="apple-touch-icon"
        href="https://drive.google.com/thumbnail?id=1reO_YhiXXVv-mw8mpYSrUrP5Pw_5MsJj&sz=w1000">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;800&display=swap"
        rel="stylesheet">
    <style>
        :root {
            --brand-primary: #8b5cf6;
            /* Violet-500 */
            --brand-secondary: #ec4899;
            /* Pink-500 */
            --safe-top: env(safe-area-inset-top, 0);
            --safe-bottom: env(safe-area-inset-bottom, 0);
        }

        body {
            font-family: 'Plus Jakarta Sans', sans-serif;
            background: #f8fafc;
            overflow-x: hidden;
            -webkit-tap-highlight-color: transparent;
            padding-bottom: var(--safe-bottom);
        }

        .glass-header {
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.3);
        }

        .bento-card {
            background: #ffffff;
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            border: 1px solid rgba(226, 232, 240, 0.8);
        }

        .bento-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            border-color: rgba(139, 92, 246, 0.2);
        }

        .bento-card:active {
            transform: scale(0.98);
        }

        .tab-indicator {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }

        @keyframes reveal {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .reveal-item {
            animation: reveal 0.6s cubic-bezier(0.2, 0.8, 0.2, 1) forwards;
        }

        @keyframes slideUp {
            from {
                transform: translateY(100%);
            }

            to {
                transform: translateY(0);
            }
        }

        .sheet-animate {
            animation: slideUp 0.5s cubic-bezier(0.32, 0.72, 0, 1);
        }

        ::-webkit-scrollbar {
            display: none;
        }

        .gradient-text {
            background: linear-gradient(135deg, var(--brand-primary), var(--brand-secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        @keyframes float {
            0% {
                transform: translateY(0px);
            }

            50% {
                transform: translateY(-3px);
            }

            100% {
                transform: translateY(0px);
            }
        }

        .animate-float {
            animation: float 3s ease-in-out infinite;
        }

        .fab-gradient {
            background: linear-gradient(135deg, var(--brand-primary), var(--brand-secondary));
            box-shadow: 0 10px 25px -5px rgba(139, 92, 246, 0.5);
        }

        .fab-gradient:hover {
            box-shadow: 0 20px 25px -5px rgba(139, 92, 246, 0.6);
        }
    </style>
</head>

<body class="text-slate-900 antialiased selection:bg-violet-200 selection:text-violet-900">

    <!-- Header -->
    <header class="glass-header sticky top-0 z-40 px-6 pt-4 pb-4 flex justify-between items-center relative"
        style="padding-top: calc(1rem + var(--safe-top));">

        <!-- Absolute centered logo -->
        <div
            class="absolute left-1/2 top-1/2 -translate-x-1/2 -translate-y-1/2 mt-2 w-full flex justify-center pointer-events-none">
            <img src="https://drive.google.com/thumbnail?id=1reO_YhiXXVv-mw8mpYSrUrP5Pw_5MsJj&sz=w1000"
                alt="CraftyHook Studio" class="h-24 w-auto object-contain animate-float pointer-events-auto"
                onerror="this.style.display='none'; document.getElementById('text-logo').classList.remove('hidden');">
        </div>

        <div class="w-10"></div> <!-- Spacer -->

        <!-- Text fallback -->
        <div id="text-logo" class="hidden absolute left-1/2 top-1/2 -translate-x-1/2 -translate-y-1/2">
            <h1 class="text-2xl font-black tracking-tighter">Crafty<span class="gradient-text">Hook</span> Studio</h1>
        </div>
        <button onclick="refreshData()"
            class="w-10 h-10 rounded-full bg-slate-100/50 hover:bg-slate-100 flex items-center justify-center text-slate-500 hover:text-slate-800 active:rotate-180 transition-all duration-500"
            aria-label="Refresh">
            <i class="fa-solid fa-rotate-right text-sm" id="refresh-icon"></i>
        </button>
    </header>

    <!-- Navigation & Search -->
    <div class="px-6 py-4 sticky z-30 glass-header border-b-0 backdrop-blur-md bg-white/50 space-y-4"
        style="top: calc(88px + var(--safe-top));">
        <!-- Tabs -->
        <div class="relative flex p-1.5 bg-slate-200/50 rounded-2xl backdrop-blur-sm">
            <button onclick="switchTab('reels')" id="tab-reels"
                class="relative z-10 flex-1 py-3 text-sm font-bold transition-colors duration-300 text-slate-900">
                <i class="fa-brands fa-instagram mr-2"></i>Media
            </button>
            <button onclick="switchTab('patterns')" id="tab-patterns"
                class="relative z-10 flex-1 py-3 text-sm font-bold transition-colors duration-300 text-slate-500">
                <i class="fa-solid fa-layer-group mr-2"></i>Patterns
            </button>
            <button onclick="switchTab('favorites')" id="tab-favorites"
                class="relative z-10 flex-1 py-3 text-sm font-bold transition-colors duration-300 text-slate-500">
                <i class="fa-solid fa-heart mr-2"></i>Favorites
            </button>
            <div id="tab-bg"
                class="tab-indicator absolute top-1.5 bottom-1.5 left-1.5 w-[calc(33.33%-4px)] bg-white rounded-xl">
            </div>
        </div>

        <!-- Search Bar -->
        <div class="relative">
            <i class="fa-solid fa-magnifying-glass absolute left-4 top-1/2 -translate-y-1/2 text-slate-400"></i>
            <input type="text" id="search-input" oninput="handleSearch()" placeholder="Search your collection..."
                class="w-full bg-white/80 border border-slate-200/60 rounded-2xl py-3 pl-11 pr-4 text-sm font-semibold text-slate-700 placeholder:text-slate-400 focus:outline-none focus:ring-2 focus:ring-violet-500/50 focus:bg-white transition-all shadow-sm">
        </div>
    </div>

    <!-- Main -->
    <main id="content" class="px-6 pb-40 pt-4">
        <div id="loader" class="flex flex-col items-center justify-center py-32 space-y-6">
            <div class="w-10 h-10 border-4 border-violet-500 border-t-transparent rounded-full animate-spin"></div>
            <p class="text-xs font-bold text-slate-400 tracking-widest uppercase">Syncing</p>
        </div>

        <div id="items-grid" class="grid grid-cols-1 gap-6 hidden">
        </div>

        <div id="empty-state" class="hidden text-center py-32">
            <div
                class="w-24 h-24 bg-slate-100 rounded-[2rem] mx-auto flex items-center justify-center mb-6 shadow-inner">
                <i class="fa-solid fa-cloud-arrow-up text-4xl text-slate-300"></i>
            </div>
            <h3 class="text-slate-900 font-extrabold text-xl mb-2">Nothing saved yet</h3>
            <p class="text-slate-500 text-sm max-w-xs mx-auto">Tap the + button to save your first reel, video, or
                pattern.</p>
        </div>
    </main>

    <!-- FAB Add -->
    <button onclick="openModal()"
        class="fixed bottom-8 right-6 w-16 h-16 fab-gradient text-white rounded-[24px] flex items-center justify-center text-2xl z-40 active:scale-90 transition-all duration-300 hover:-translate-y-1"
        style="bottom: calc(2rem + var(--safe-bottom));" aria-label="Add item">
        <i class="fa-solid fa-plus"></i>
    </button>

    <!-- Add Item Bottom Sheet -->
    <div id="addModal"
        class="fixed inset-0 z-50 hidden flex-col justify-end bg-slate-900/60 backdrop-blur-sm transition-opacity duration-300">
        <div class="absolute inset-0" onclick="closeModal()"></div>
        <div class="bg-white rounded-t-[40px] px-8 pt-6 pb-12 shadow-2xl relative sheet-animate"
            style="padding-bottom: calc(3rem + var(--safe-bottom));">
            <div class="w-12 h-1.5 bg-slate-200 rounded-full mx-auto mb-8"></div>

            <h2 class="text-2xl font-black mb-8 text-center text-slate-900 tracking-tight">Save Inspiration</h2>

            <form id="saveForm" onsubmit="handleSave(event)" class="space-y-6">
                <div class="flex p-1.5 bg-slate-100 rounded-2xl">
                    <button type="button" onclick="setFormType('reels')" id="f-reels"
                        class="flex-1 py-3.5 rounded-xl font-bold text-sm bg-white shadow-sm border border-slate-200 text-slate-900 transition-all">Media</button>
                    <button type="button" onclick="setFormType('patterns')" id="f-patterns"
                        class="flex-1 py-3.5 rounded-xl font-bold text-sm text-slate-500 hover:text-slate-700 transition-all">Pattern</button>
                </div>
                <input type="hidden" id="itemType" value="reels">

                <div class="space-y-3">
                    <label class="text-[11px] font-extrabold text-slate-400 uppercase tracking-widest ml-1">Link</label>
                    <div class="relative">
                        <input type="url" id="url" placeholder="Paste Instagram or YouTube link..." required
                            class="w-full bg-slate-50 border border-slate-200 rounded-2xl p-5 pl-12 outline-none focus:ring-2 focus:ring-violet-500 focus:border-transparent font-medium transition-all text-slate-900 placeholder:text-slate-400">
                        <div class="absolute left-5 top-1/2 -translate-y-1/2 text-slate-400">
                            <i class="fa-solid fa-link"></i>
                        </div>
                    </div>
                </div>

                <div class="space-y-3">
                    <label
                        class="text-[11px] font-extrabold text-slate-400 uppercase tracking-widest ml-1">Title</label>
                    <input type="text" id="title" placeholder="Give it a name..." required
                        class="w-full bg-slate-50 border border-slate-200 rounded-2xl p-5 outline-none focus:ring-2 focus:ring-violet-500 focus:border-transparent font-bold transition-all text-slate-900 placeholder:text-slate-400">
                </div>

                <button type="submit" id="submit-btn"
                    class="w-full fab-gradient text-white font-black py-5 rounded-2xl shadow-xl shadow-violet-200 mt-6 active:scale-98 transition-all uppercase tracking-widest text-sm hover:shadow-2xl">
                    Save It
                </button>
            </form>
        </div>
    </div>

    <!-- YouTube in-app modal -->
    <div id="youtube-modal"
        class="fixed inset-0 z-50 hidden items-center justify-center bg-black/95 p-4 backdrop-blur-xl"
        style="padding-top: calc(1rem + var(--safe-top)); padding-bottom: calc(1rem + var(--safe-bottom));">
        <div
            class="bg-black rounded-3xl w-full max-w-3xl overflow-hidden flex flex-col shadow-2xl border border-white/10">
            <div class="flex justify-between items-center p-6 border-b border-white/10">
                <h3 id="youtube-modal-title" class="font-bold text-white truncate pr-4 text-lg">Video</h3>
                <button type="button" onclick="closeYoutubeModal()"
                    class="w-10 h-10 rounded-full bg-white/10 hover:bg-white/20 flex items-center justify-center text-white transition-colors"
                    aria-label="Close">&times;</button>
            </div>
            <div class="relative w-full bg-black aspect-video">
                <iframe id="youtube-iframe" src="" class="absolute top-0 left-0 w-full h-full"
                    allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
                    allowfullscreen></iframe>
            </div>
        </div>
    </div>

    <!-- Toast -->
    <div id="toast"
        class="fixed top-6 left-1/2 -translate-x-1/2 bg-slate-900/90 backdrop-blur-md text-white px-6 py-3 rounded-full text-sm font-bold opacity-0 transition-all pointer-events-none z-[60] flex items-center shadow-xl transform translate-y-[-100%]"
        style="top: calc(1rem + var(--safe-top));">
        <i class="fa-solid fa-check-circle mr-2 text-green-400"></i>
        <span id="toast-msg">Saved</span>
    </div>

    <script>
        // *** IMPORTANT: REPLACE THIS URL WITH YOUR DEPLOYED GOOGLE APPS SCRIPT WEB APP URL ***
        const API_URL = 'https://script.google.com/macros/s/AKfycbx7duntxoysWw3UnKHIIdgXOHJ7w30n_OdlhtiAR1y8_2_meqevFbRSTJhCCctkxTwHVg/exec';

        let items = [];
        let favorites = [];
        let currentTab = 'reels';
        let searchQuery = '';

        // Auto-detect URL type in Add Modal
        const urlInput = document.getElementById('url');
        urlInput.addEventListener('input', function (e) {
            const val = e.target.value.toLowerCase();
            if (val.includes('youtube.com') || val.includes('youtu.be') || val.includes('instagram.com') || val.includes('tiktok.com')) {
                setFormType('reels');
            }
        });

        function loadFavoritesFromLocal() {
            let stored = localStorage.getItem('craftyhook_favs');
            if (stored) {
                favorites = JSON.parse(stored);
            }
        }

        function isFav(itemId, sheetType) {
            return favorites.some(f => f.itemId === itemId && f.sheetType === sheetType);
        }

        function showToast(msg, isError) {
            var toast = document.getElementById('toast');
            document.getElementById('toast-msg').textContent = msg;
            toast.querySelector('i').className = isError ? 'fa-solid fa-exclamation-circle mr-2 text-red-400' : 'fa-solid fa-check-circle mr-2 text-green-400';
            toast.classList.remove('opacity-0');
            toast.classList.remove('translate-y-[-100%]');
            toast.classList.add('translate-y-0');

            setTimeout(function () {
                toast.classList.add('opacity-0');
                toast.classList.add('translate-y-[-100%]');
                toast.classList.remove('translate-y-0');
            }, 3000);
        }

        function switchTab(t) {
            currentTab = t;
            var bg = document.getElementById('tab-bg');
            var reelsBtn = document.getElementById('tab-reels');
            var patternsBtn = document.getElementById('tab-patterns');
            var favsBtn = document.getElementById('tab-favorites');

            // Reset all buttons
            reelsBtn.className = 'relative z-10 flex-1 py-3 text-sm font-bold transition-colors duration-300 text-slate-500';
            patternsBtn.className = 'relative z-10 flex-1 py-3 text-sm font-bold transition-colors duration-300 text-slate-500';
            favsBtn.className = 'relative z-10 flex-1 py-3 text-sm font-bold transition-colors duration-300 text-slate-500';

            if (t === 'reels') {
                bg.style.left = '6px';
                reelsBtn.classList.replace('text-slate-500', 'text-slate-900');
            } else if (t === 'patterns') {
                bg.style.left = 'calc(33.33% + 4px)';
                patternsBtn.classList.replace('text-slate-500', 'text-slate-900');
            } else {
                bg.style.left = 'calc(66.66% + 2px)';
                favsBtn.classList.replace('text-slate-500', 'text-slate-900');
            }
            render();
        }

        async function refreshData() {
            var icon = document.getElementById('refresh-icon');
            if (icon) {
                icon.classList.add('animate-spin');
            }
            document.getElementById('loader').classList.remove('hidden');
            document.getElementById('items-grid').classList.add('hidden');
            document.getElementById('empty-state').classList.add('hidden');

            try {
                // Fetch Items
                let res = await fetch(`${API_URL}?action=getData`);
                let data = await res.json();
                items = data;

                loadFavoritesFromLocal();

                render();
            } catch (err) {
                console.error(err);
                showToast('Failed to load data', true);
            } finally {
                if (icon) {
                    icon.classList.remove('animate-spin');
                }
                document.getElementById('loader').classList.add('hidden');
            }
        }

        function openVideo(item) {
            if (item.platform === 'youtube' && item.embedUrl) {
                document.getElementById('youtube-modal-title').textContent = item.title;
                document.getElementById('youtube-iframe').src = item.embedUrl + '?autoplay=1';
                document.getElementById('youtube-modal').classList.remove('hidden');
                document.getElementById('youtube-modal').classList.add('flex');
            } else {
                window.open(item.url, '_blank', 'noopener');
            }
        }

        function closeYoutubeModal() {
            document.getElementById('youtube-modal').classList.add('hidden');
            document.getElementById('youtube-modal').classList.remove('flex');
            document.getElementById('youtube-iframe').src = '';
        }

        async function toggleFav(itemId, sheetType) {
            var newFav = !isFav(itemId, sheetType);

            // Update Local State
            if (newFav) {
                favorites.push({ itemId, sheetType });
            } else {
                favorites = favorites.filter(f => !(f.itemId === itemId && f.sheetType === sheetType));
            }
            localStorage.setItem('craftyhook_favs', JSON.stringify(favorites));
            render();

            // Optional: Sync to backend if needed, but for public PWA, local storage is better for personal favorites
        }

        async function deleteItem(itemId, sheetType) {
            if (!confirm('Are you sure you want to delete this item?')) return;

            // Optimistic update
            const originalItems = [...items];
            items = items.filter(i => i.id !== itemId);
            render();

            try {
                let res = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'text/plain' }, // CORS hack
                    body: JSON.stringify({
                        action: 'deleteItem',
                        itemId: itemId,
                        sheetType: sheetType
                    })
                });
                let json = await res.json();
                if (json.error) throw new Error(json.error);
                showToast('Item deleted');
            } catch (err) {
                items = originalItems; // Revert
                render();
                showToast('Failed to delete', true);
            }
        }

        function copyLink(url) {
            var el = document.createElement('textarea');
            el.value = url;
            document.body.appendChild(el);
            el.select();
            document.execCommand('copy');
            document.body.removeChild(el);
            showToast('Link copied');
        }

        function handleSearch() {
            searchQuery = document.getElementById('search-input').value.toLowerCase();
            render();
        }

        function getPlatformLabel(item) {
            if (item.type === 'patterns') return 'PATTERN';
            switch (item.platform) {
                case 'youtube': return 'YOUTUBE';
                case 'instagram': return 'INSTAGRAM';
                case 'tiktok': return 'TIKTOK';
                case 'facebook': return 'FACEBOOK';
                default: return 'VIDEO';
            }
        }

        function getPlatformIcon(item) {
            if (item.type === 'patterns') return 'fa-solid fa-layer-group text-slate-500';
            switch (item.platform) {
                case 'youtube': return 'fa-brands fa-youtube text-red-600';
                case 'instagram': return 'fa-brands fa-instagram text-pink-600';
                case 'tiktok': return 'fa-brands fa-tiktok text-black';
                case 'facebook': return 'fa-brands fa-facebook text-blue-600';
                default: return 'fa-solid fa-video text-violet-500';
            }
        }

        function render() {
            var grid = document.getElementById('items-grid');

            // Filter by tab
            var filtered = items.filter(function (i) {
                if (currentTab === 'favorites') {
                    return isFav(i.id, i.type);
                }
                return i.type === currentTab;
            });

            // Filter by search query
            if (searchQuery) {
                filtered = filtered.filter(function (i) {
                    return (i.title && i.title.toLowerCase().includes(searchQuery)) ||
                        (i.url && i.url.toLowerCase().includes(searchQuery));
                });
            }

            grid.innerHTML = '';
            document.getElementById('empty-state').classList.add('hidden');

            if (filtered.length === 0) {
                grid.classList.add('hidden');
                document.getElementById('empty-state').classList.remove('hidden');
                // Customize empty state message based on context?
                return;
            }

            grid.classList.remove('hidden');
            filtered.forEach(function (item, idx) {
                var sheetType = item.type === 'reels' ? 'reels' : 'patterns';
                var fav = isFav(item.id, item.type);
                var card = document.createElement('div');
                card.className = 'bento-card p-5 rounded-[28px] flex flex-col space-y-4 reveal-item relative group';
                card.style.animationDelay = (idx * 0.05) + 's';

                var iconClass = getPlatformIcon(item);
                var typeLabel = getPlatformLabel(item);
                var escapedTitle = (item.title || '').replace(/</g, '&lt;').replace(/"/g, '&quot;');
                var escapedUrl = (item.url || '').replace(/</g, '&lt;').replace(/"/g, '&quot;');

                var isYoutube = item.type === 'reels' && item.platform === 'youtube';

                // Delete button logic
                var deleteBtn = `
                    <button type="button" onclick="deleteItem('${String(item.id).replace(/'/g, "\\'")}', '${sheetType}')" class="absolute top-4 right-4 w-8 h-8 rounded-full bg-slate-50 text-slate-300 hover:bg-red-50 hover:text-red-500 opacity-0 group-hover:opacity-100 transition-all duration-200 flex items-center justify-center z-10" aria-label="Delete">
                        <i class="fa-solid fa-trash-can text-xs"></i>
                    </button>
                `;

                card.innerHTML =
                    deleteBtn +
                    '<div class="flex justify-between items-start gap-3">' +
                    '  <div class="flex items-center space-x-3 flex-1 min-w-0 pr-8">' +
                    '    <div class="w-12 h-12 rounded-2xl bg-slate-50 flex items-center justify-center flex-shrink-0 border border-slate-100">' +
                    '      <i class="' + iconClass + ' text-xl"></i>' +
                    '    </div>' +
                    '    <div class="min-w-0 flex-1">' +
                    '      <p class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-0.5">' + typeLabel + '</p>' +
                    '      <h3 class="text-[15px] font-bold text-slate-900 truncate leading-tight">' + escapedTitle + '</h3>' +
                    '    </div>' +
                    '  </div>' +
                    '</div>' +

                    '<div class="flex items-center gap-3 pt-2">' +
                    (isYoutube
                        ? '<button type="button" class="launch-btn flex-1 py-3.5 rounded-xl bg-slate-900 text-white text-[11px] font-bold tracking-widest uppercase flex items-center justify-center space-x-2 hover:bg-slate-800 transition-colors shadow-lg shadow-slate-200">' +
                        '<span>Play</span><i class="fa-solid fa-play text-[9px]"></i></button>'
                        : '<a href="' + escapedUrl + '" target="_blank" rel="noopener" class="flex-1 py-3.5 rounded-xl bg-slate-900 text-white text-[11px] font-bold tracking-widest uppercase flex items-center justify-center space-x-2 hover:bg-slate-800 transition-colors shadow-lg shadow-slate-200">' +
                        '<span>Open</span><i class="fa-solid fa-arrow-up-right-from-square text-[9px]"></i></a>') +

                    '<div class="flex gap-2">' +
                    '<button type="button" onclick="toggleFav(\'' + String(item.id).replace(/'/g, "\\'") + '\', \'' + sheetType + '\')" class="w-11 h-11 rounded-xl flex items-center justify-center transition-all border ' + (fav ? 'bg-pink-50 text-pink-500 border-pink-100' : 'bg-white text-slate-400 border-slate-200 hover:border-slate-300') + '" aria-label="Favorite">' +
                    '  <i class="fa-' + (fav ? 'solid' : 'regular') + ' fa-heart text-sm"></i>' +
                    '</button>' +
                    '<button type="button" onclick="copyLink(\'' + escapedUrl.replace(/'/g, "\\'") + '\')" class="w-11 h-11 rounded-xl bg-white text-slate-400 border border-slate-200 hover:border-slate-300 hover:text-slate-600 active:bg-slate-50 transition-all flex items-center justify-center" aria-label="Copy link">' +
                    '  <i class="fa-regular fa-copy text-sm"></i>' +
                    '</button>' +
                    '</div>' +
                    '</div>';
                grid.appendChild(card);
                if (isYoutube) {
                    var launchBtn = card.querySelector('.launch-btn');
                    if (launchBtn) launchBtn.onclick = function () { openVideo(item); };
                }
            });
        }

        function openModal() {
            document.getElementById('addModal').classList.remove('hidden');
            document.getElementById('addModal').classList.add('flex');
            document.getElementById('url').focus(); // Auto focus
        }

        function closeModal() {
            document.getElementById('addModal').classList.add('hidden');
            /* setTimeout to remove flex class if needed, but css hidden override is enough usually */
        }

        function setFormType(t) {
            document.getElementById('itemType').value = t;
            var fr = document.getElementById('f-reels');
            var fp = document.getElementById('f-patterns');
            if (t === 'reels') {
                fr.className = 'flex-1 py-3.5 rounded-xl font-bold text-sm bg-white shadow-sm border border-slate-200 text-slate-900 transition-all';
                fp.className = 'flex-1 py-3.5 rounded-xl font-bold text-sm text-slate-500 hover:text-slate-700 transition-all';
            } else {
                fp.className = 'flex-1 py-3.5 rounded-xl font-bold text-sm bg-white shadow-sm border border-slate-200 text-slate-900 transition-all';
                fr.className = 'flex-1 py-3.5 rounded-xl font-bold text-sm text-slate-500 hover:text-slate-700 transition-all';
            }
        }

        async function handleSave(e) {
            e.preventDefault();
            var btn = document.getElementById('submit-btn');
            btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i>';
            btn.disabled = true;

            var data = {
                type: document.getElementById('itemType').value,
                title: document.getElementById('title').value.trim(),
                url: document.getElementById('url').value.trim()
            };

            try {
                let res = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'text/plain' },
                    body: JSON.stringify({
                        action: 'saveItem',
                        payload: data
                    })
                });
                let json = await res.json();

                if (json.error) {
                    throw new Error(json.error);
                }

                closeModal();
                document.getElementById('saveForm').reset();
                setFormType('reels');
                refreshData();
                showToast('Saved!');
            } catch (err) {
                showToast('Failed to save.', true);
            } finally {
                btn.innerHTML = 'Save It';
                btn.disabled = false;
            }
        }

        // Register Service Worker
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js')
                    .then(reg => console.log('SW Registered', reg))
                    .catch(err => console.log('SW Fail', err));
            });
        }

        // Initial Load
        window.addEventListener('DOMContentLoaded', refreshData);

        document.getElementById('youtube-modal').addEventListener('click', function (e) {
            if (e.target === this) closeYoutubeModal();
        });
    </script>
</body>


</html>
